global
    stats socket /run/haproxy.sock mode 660 level admin

defaults
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    option httplog
    log stdout local0
    mode http

frontend proxy
    bind :80
    
    # Deny if missing key
    acl has_apikey hdr(apikey) -m found
    http-request deny deny_status 401 if !has_apikey

    # Deny if bad key
    acl basic_valid_apikey hdr(apikey) -m str 7B5zIqmRGXmrJTFmKa99-b QzVV6y1EmQFbbxOfRCwy-b mGcjH8Fv6U9y3BVF9H3Y-b
    acl pro_valid_apikey hdr(apikey) -m str qmFm7B5zIKa99vcitRGX-p RCwyJs35QzVV6y1EmQFb-p H8Fv6UmGcj9y3Bb9TVF9-p
    http-request deny deny_status 403 if !basic_valid_apikey !pro_valid_apikey
    
    # Route request to the right backend (considers both /pets and /pets/)
    use_backend basic_pets_GET if basic_valid_apikey METH_GET { path_reg \/pets\/?$ } 
    use_backend basic_pets_POST if basic_valid_apikey METH_POST { path_reg \/pets\/?$ } 
    use_backend basic_petsid_GET if basic_valid_apikey METH_GET { path_reg \/pets(?:\/[^/]+){1}\/?$ } 
    use_backend basic_petsid_PUT if basic_valid_apikey METH_PUT { path_reg \/pets(?:\/[^/]+){1}\/?$ } 
    use_backend basic_petsid_DELETE if basic_valid_apikey METH_DELETE { path_reg \/pets(?:\/[^/]+){1}\/?$ } 
    use_backend pro_pets_GET if pro_valid_apikey METH_GET { path_reg \/pets\/?$ } 
    use_backend pro_pets_POST if pro_valid_apikey METH_POST { path_reg \/pets\/?$ } 
    use_backend pro_petsid_GET if pro_valid_apikey METH_GET { path_reg \/pets(?:\/[^/]+){1}\/?$ } 
    use_backend pro_petsid_PUT if pro_valid_apikey METH_PUT { path_reg \/pets(?:\/[^/]+){1}\/?$ } 
    use_backend pro_petsid_DELETE if pro_valid_apikey METH_DELETE { path_reg \/pets(?:\/[^/]+){1}\/?$ } 
    use_backend no_ratelimit_endpoints if METH_GET { path_reg \/open-endpoint\/?$ }
    use_backend no_ratelimit_endpoints if METH_POST { path_reg \/open-endpoint\/?$ }
    
    # NO MATCHING PATH? -> 404
    default_backend response-404-server

backend response-404-server
    http-request deny deny_status 404

backend no_ratelimit_endpoints
    server no_ratelimit_endpoints api:9999

backend basic_pets_GET
    stick-table type binary len 20 size 100k expire 1s store http_req_rate(1s)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 1
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server pets api:9999
backend basic_pets_POST
    stick-table type binary len 20 size 100k expire 1m store http_req_rate(1m)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 2
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server pets api:9999
backend basic_petsid_GET
    stick-table type binary len 20 size 100k expire 1s store http_req_rate(1s)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 3
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server petsid api:9999
backend basic_petsid_PUT
    stick-table type binary len 20 size 100k expire 1m store http_req_rate(1m)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 4
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server petsid api:9999
backend basic_petsid_DELETE
    stick-table type binary len 20 size 100k expire 1s store http_req_rate(1s)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 5
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server petsid api:9999
backend pro_pets_GET
    stick-table type binary len 20 size 100k expire 1s store http_req_rate(1s)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 10
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server pets api:9999
backend pro_pets_POST
    stick-table type binary len 20 size 100k expire 1m store http_req_rate(1m)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 20
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server pets api:9999
backend pro_petsid_GET
    stick-table type binary len 20 size 100k expire 1s store http_req_rate(1s)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 30
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server petsid api:9999
backend pro_petsid_PUT
    stick-table type binary len 20 size 100k expire 1m store http_req_rate(1m)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 40
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server petsid api:9999
backend pro_petsid_DELETE
    stick-table type binary len 20 size 100k expire 1s store http_req_rate(1s)
    acl exceeds_limit hdr(apikey),table_http_req_rate() gt 50
    http-request track-sc0 hdr(apikey) unless exceeds_limit
    http-request deny deny_status 429 if exceeds_limit
    server petsid api:9999

