global
    stats socket /run/haproxy.sock mode 660 level admin

defaults
    timeout connect 10s
    timeout client 1m
    timeout server 1m

frontend proxy
    bind :80
    mode http
    default_backend default-server
    use_backend once-per-second-endpoint if { path_beg /once-per-second-endpoint } 
    use_backend twice-per-minute-endpoint if { path_beg /twice-per-minute-endpoint } 
    

backend default-server
    mode http
    server default-server api:9999

backend once-per-second-endpoint
    mode http
    stick-table type binary len 20 size 100k expire 1s store http_req_rate(1s)
    acl has_token url_param(apikey) -m found
    acl exceeds_limit url_param(apikey),table_http_req_rate() gt 1
    http-request track-sc0 url_param(apikey) unless exceeds_limit
    http-request deny deny_status 403 if !has_token
    http-request deny deny_status 429 if exceeds_limit
    server once-per-second-endpoint api:9999 

backend twice-per-minute-endpoint
    mode http
    stick-table type binary len 20 size 100k expire 1m store http_req_rate(1m)
    acl has_token url_param(apikey) -m found
    acl exceeds_limit url_param(apikey),table_http_req_rate() gt 2
    http-request track-sc0 url_param(apikey) unless exceeds_limit
    http-request deny deny_status 403 if !has_token
    http-request deny deny_status 429 if exceeds_limit
    server twice-per-minute-endpoint api:9999 


