# Envoy

While Envoy supports both [Local](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/local_rate_limiting) and [Global](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting) Rate Limiting, SLA Wizard makes use of the former given the later requires an additional service.  

Additionally, unlike other proxies, Envoy does not provide rate limiting based on grouping of specific parameters like headers or query parameters.
Instead, the approach to follow is to use RouteMatch to get to a specific rate limiting. For example, if the SLA indicates a limit of 2 POST requests per minute to `/pets`, then the Envoy configuration file will include a RouteMatch which checks for requests that match:

- path is /pets
- method is POST
- APIKey header is user123

It will group all the request that match those conditions and apply rate limiting based on that. Because of this approach, if a request is sent without an apikey or with a wrong one, the proxy will respond with HTTP code 404 instead of 429.

The following table provides aditional details on the three possible API key locations are implemented on Envoy configuration files generated by SLA Wizard:

| API key location | Implementation                                                                                                                                                                                                                                                                            |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Header           | Requests are matched using RouteMatch's headers to look for the APIKey header.                                                                                                                                                                                                            |
| Query            | Requests are matched using RouteMatch's query_parameters to look for the APIkey header.                                                                                                                                                                                                   |
| URL              | None of headers or query_parameters are used, instead the APIKey is searched for in the request's path. In the case the path is correct, it is later modified to remove the APIkey from the url prior to sending it to the upstream server (i.e the actual API server behind the proxy) . |

To create a configuration file for an Envoy proxy, use the argument `envoy` of the `config` command, for example:

```bash
node src/index.js config envoy --oas tests/specs/simple_api_oas.yaml --sla tests/specs/slas/ --outFile tests/proxy-configuration-envoy.yaml
```

**Note**: currently, [global rate limit](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting) is not supported, only [local rate limit](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/local_rate_limit_filter).

## Custom Template

Refer to [`templates/envoy.yaml`](../templates/envoy.yaml). The template provided to SLA Wizard must follow that exact structure. Note `sla-wizard` adds the rate limiting configuration under `routes:`.
