# Testing

TODO: this should be done with `runTest`

```bash
node src/index.js runTest --oas tests/specs/simple_api_oas.yaml --sla tests/specs/slas/ --specs tests/basicTestConfig.yaml 
```

The following steps indicate how to create proxy configuration files and validate they work as expected. SLA Wizard uses both the API's OAS and SLA definitions for that.

## 1. Create proxy config

To create the config file of a proxy use the following command:

```bash
node src/index.js config <proxy> --oas <pathToOAS> --sla <pathToSLA> --outFile <destinationFile>
```

## 2. Spin up two containers: proxy and API

For this, docker-compose is used. The variable `CFG_PATH` should point to the configuration file created in the previous step. The path should be relative to where the docker-compose YAML file is.

### NGINX

```bash
sudo CFG_PATH=../proxy-configuration-nginx docker-compose --file tests/nginx/docker-compose-nginx.yaml up --build
```

### HAProxy

```bash
sudo CFG_PATH=../proxy-configuration-haproxy docker-compose --file tests/haproxy/docker-compose-haproxy.yaml up --build
```

### Traefik

In the case of Traefik, the file that SLA Wizard writes is the dynamic configuration file. The static configuration file is not generated by SLA Wizard, it should look like this:

```yaml
entryPoints:
  http:
    address: ':80'
  https:
    address: ':443'
providers:
  file:
    filename: /etc/traefik/traefik-dynamic-cfg.yaml
```

Where `provider.file.filename` contains the path to the dynamic configuration file created by SLA Wizard. When spinning up the containers as in the command below, the variable `D_CFG_PATH` indicates the path to the dynamic configuration file:

```bash
sudo D_CFG_PATH=../proxy-configuration-traefik.yaml CFG_PATH=./traefik.yaml docker-compose --file tests/traefik/docker-compose-traefik.yaml up --build
```

### Envoy

```bash
sudo CFG_PATH=../proxy-configuration-envoy.yaml docker-compose --file tests/envoy/docker-compose-envoy.yaml up --build
```

## 3. Validate that the proxy is properly configured

### APIPecker

Source: https://www.npmjs.com/package/apipecker

```bash

# apipecker <concurrentUsers> <iterations> <delay in ms> <url> [-v]

apipecker 5 10 500 http://localhost/open-endpoint -v # should succeed

apipecker 1 5 1100 http://localhost/first-endpoint -v # should succeed

apipecker 1 10 700 http://localhost/first-endpoint -v # half should fail

```
